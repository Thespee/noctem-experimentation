# v0.6.0 Polish Implementation Plan
Implement the four polish items plus suggested improvements for the "royal scribe" capture system.
## Problem Statement
Current system routes inputs directly to tasks/commands without universal capture. Need:
* All inputs captured as "thoughts" first (royal scribe pattern)
* Fast classifier with confidence scoring to route appropriately
* Voice transcriptions parsed into actionable tasks
* Ambiguous inputs surfaced via Butler clarification
* Context-aware task suggestions considering calendar gaps
* Transparent contact budget display
## Current State
* `parse_command()` is binary: command or NEW_TASK
* Voice journals transcribed but not parsed into tasks
* No `thoughts` table for universal capture
* No confidence scoring on classification
* `get_butler_status_message()` shows "X/5 remaining" format
* Tasks have no `duration_minutes` field
* Suggestions don't consider calendar availability
## Proposed Changes
### Phase 1: Database Schema Updates
**Files:** `noctem/db.py`, `noctem/models.py`
Add new tables and columns:
```SQL
-- Universal capture for all inputs
CREATE TABLE thoughts (
    id INTEGER PRIMARY KEY,
    source TEXT,                    -- 'telegram', 'cli', 'web', 'voice'
    raw_text TEXT NOT NULL,
    kind TEXT,                      -- 'actionable', 'note', 'ambiguous'
    ambiguity_reason TEXT,          -- 'scope', 'timing', 'intent', null
    confidence REAL,                -- 0.0-1.0 classifier confidence
    linked_task_id INTEGER,
    linked_project_id INTEGER,
    voice_journal_id INTEGER,       -- Link to source voice journal
    status TEXT DEFAULT 'pending',  -- 'pending', 'processed', 'clarified'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP
);
-- Add duration to tasks
ALTER TABLE tasks ADD COLUMN duration_minutes INTEGER;
```
Add `Thought` dataclass to models.py with `from_row()` method.
### Phase 2: Fast Classifier Module
**New file:** `noctem/fast/classifier.py`
Create rule-based classifier with confidence scoring:
* `classify_input(text: str, source: str) -> ClassificationResult`
* Returns: `kind`, `confidence`, `ambiguity_reason`, `parsed_task` (if actionable)
* Confidence thresholds:
    * `>0.8`: Auto-route (high confidence)
    * `0.5-0.8`: Route but flag for review
    * `<0.5`: Queue for Butler clarification
Classification signals:
* **Actionable (high confidence)**: Contains date/time, importance marker (!1-3), action verbs, project tag
* **Note**: Starts with "note:", "remember:", "idea:", or contains "learned", "realized"
* **Ambiguous**: Vague scope, missing context, could be project or task
### Phase 3: Voice Cleanup Utility
**New file:** `noctem/fast/voice_cleanup.py`
Light normalization for voice transcripts:
* Remove filler words: "um", "uh", "like", "you know"
* Normalize hesitation patterns: "I... I need to" → "I need to"
* Preserve semantic content
### Phase 4: Thoughts-First Capture System
**Files:** `noctem/fast/capture.py` (new), `noctem/cli.py`, `noctem/handlers/`
Universal capture flow:
```warp-runnable-command
process_input(text, source) -> CaptureResult
  1. Create thought record (raw capture)
  2. Run classifier
  3. If actionable + high confidence:
     - Create task via existing task_parser
     - Link thought → task
     - Return confirmation with "*" hint
  4. If note:
     - Keep as thought (status='processed')
     - Return acknowledgment
  5. If ambiguous:
     - Queue for Butler clarification
     - Return "Got it, I'll ask about this later"
```
Update CLI's `handle_input()` to use new capture system.
### Phase 5: Voice → Task Pipeline
**Files:** `noctem/slow/loop.py`, `noctem/fast/capture.py`
After Whisper transcription completes:
1. Clean transcript via voice_cleanup
2. Create thought record (source='voice', voice_journal_id=X)
3. Run through classifier
4. If actionable: create task, return one-line confirm
5. Store result for next user interaction to show confirm with `*` option
Add `pending_voice_confirmations` tracking for showing confirms when user next interacts.
### Phase 6: Butler Clarification Enhancements
**Files:** `noctem/butler/clarifications.py`, `noctem/butler/updates.py`
Enhance clarification system:
* Query oldest ambiguous thoughts (not just tasks)
* Generate subcategory-specific questions:
    * `ambiguous_scope`: "Is this a new project or a single task?"
    * `ambiguous_timing`: "When should this be done?"
    * `ambiguous_intent`: "Should I remind you about this, or is it actionable?"
* Link resolved thoughts to created entities
Update `generate_clarification_message()` to include thoughts.
### Phase 7: Context-Aware Suggestions
**New file:** `noctem/services/suggestion_service.py`
Smart task suggestions considering:
1. **Calendar gaps**: Find free time blocks between meetings
2. **Task duration**: Match tasks to available time windows
3. **Time of day**: Consider current time when suggesting
Functions:
* `get_calendar_gaps(date) -> List[TimeGap]`
* `get_fitting_tasks(gap: TimeGap) -> List[Task]`
* `get_contextual_suggestions() -> List[Suggestion]`
Each suggestion includes:
* Task reference
* Suggested time window
* Fit explanation ("fits your 2pm-3pm gap")
### Phase 8: Contact Budget Transparency
**Files:** `noctem/butler/protocol.py`
Update `get_butler_status_message()`:
* Change format: "2/5 contacts used this week" (was "3/5 remaining")
* Add next scheduled contact with actual datetime
* Calculate next contact based on current day and configured schedule
Update `get_next_scheduled_contact()` to return full datetime, not just day name.
## Testing Strategy
Create comprehensive tests for each phase:
### Test Files
1. `tests/test_v060_polish_classifier.py` - Fast classifier tests
2. `tests/test_v060_polish_thoughts.py` - Thoughts capture tests
3. `tests/test_v060_polish_voice.py` - Voice → Task pipeline tests
4. `tests/test_v060_polish_suggestions.py` - Context-aware suggestions tests
5. `tests/test_v060_polish_butler.py` - Updated butler tests
### Key Test Cases
**Classifier:**
* High confidence actionable: "buy milk tomorrow !1" → actionable, >0.8
* Note: "note: learned about X" → note, >0.8
* Ambiguous: "that project thing" → ambiguous, <0.5
* Voice cleanup: "um I need to uh call mom" → "I need to call mom"
**Thoughts Capture:**
* All inputs create thought record
* Actionable thoughts link to created tasks
* Ambiguous thoughts queued for clarification
**Voice Pipeline:**
* Transcription triggers classification
* Actionable voice → task + confirmation
* Confirmation shows `*` correction hint
**Suggestions:**
* Tasks with duration matched to calendar gaps
* No suggestions during busy periods
* Time-appropriate suggestions
**Butler:**
* Status shows "X/5 used" format
* Next contact shows full datetime
* Clarification includes ambiguous thoughts
## Implementation Order
1. Phase 1: Database schema (foundation)
2. Phase 2: Fast classifier (core logic)
3. Phase 3: Voice cleanup (utility)
4. Phase 4: Thoughts capture (integration)
5. Phase 5: Voice → Task (builds on 2-4)
6. Phase 6: Butler clarifications (builds on 4)
7. Phase 7: Context suggestions (independent)
8. Phase 8: Budget transparency (quick win)
Run tests after each phase before proceeding.