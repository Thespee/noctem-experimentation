#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: us
  
  # Identity - change these!
  identity:
    hostname: noctem
    username: noctem
    # Password: "noctem" - change this after install!
    # Generate your own with: openssl passwd -6 yourpassword
    password: "$6$rounds=4096$xyz$LkPbKhJ6.7yFs7gT5kHzVvPwGEpIhvV9K5rK5xPfvCkVwG5D1N6F0C.GK8HdKx3mXFQyL1v0fGjZ7VJvPkj/q."

  # SSH - add your public key here
  ssh:
    install-server: true
    authorized-keys:
      - "ssh-rsa YOUR_PUBLIC_KEY_HERE"
    allow-pw: true

  # Storage layout for 1TB USB
  storage:
    config:
      # The disk
      - id: disk0
        type: disk
        ptable: gpt
        wipe: superblock-recursive
        grub_device: true
        match:
          size: largest

      # Partition 1: EFI (512MB)
      - id: efi-part
        type: partition
        device: disk0
        size: 512M
        flag: boot
        grub_device: true

      - id: efi-format
        type: format
        fstype: fat32
        volume: efi-part

      - id: efi-mount
        type: mount
        path: /boot/efi
        device: efi-format

      # Partition 2: Linux root (~800GB)
      - id: root-part
        type: partition
        device: disk0
        size: 800G

      - id: root-format
        type: format
        fstype: ext4
        volume: root-part

      - id: root-mount
        type: mount
        path: /
        device: root-format

      # Partition 3: Shared (~128GB, remaining space)
      # Note: exFAT formatting done post-install via late-commands
      - id: shared-part
        type: partition
        device: disk0
        size: -1  # Use remaining space

  # Commands to run after install
  late-commands:
    # Format shared partition as exFAT
    - curtin in-target -- apt-get install -y exfatprogs
    - mkfs.exfat -L SHARED /dev/disk/by-id/*-part3 || true
    
    # Set timezone
    - curtin in-target -- timedatectl set-timezone America/Los_Angeles
    
    # Install essential packages
    - curtin in-target -- apt-get update
    - curtin in-target -- apt-get install -y python3 python3-pip git curl

  # Auto-reboot when done
  shutdown: reboot
